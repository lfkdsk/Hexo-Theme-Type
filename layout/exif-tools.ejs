<script src="js/mini-live-photo.js"></script>
<script src="js/html2canvas.js"></script>
<section class="pjax-area">
    <%- include('_partial/single-photo.ejs') %>
        <script type="module">
            var imageBox = document.getElementById("imgbox"); // imageBox 是放置大图片的图框
            var descBox = $("#descbox");
            var nextBox = $("#nextbox");
            var copyBox = $("#copybox");
            var wrapper = $("#exif-wrapper");
            var normalWrapper = $("#normal-wrapper");
            var normalData = $("#no-exif-data");

            let currentFilename = 'image';
            let currentObjectUrl = null;
            const AUTHOR_KEY = 'exif-tools:author';
            let currentAuthor = localStorage.getItem(AUTHOR_KEY) || "<%- config.author %>";
            let hasLoadedImage = false;
            let lastExifData = null;
            let lastHasExif = false;
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.hidden = true;
            document.body.appendChild(fileInput);

            // hide useless button
            $("#tools-wrapper").show();
            $("#nextbox").hide();
            copyBox.text('LOAD');
            copyBox.show();

            const authorBtn = document.createElement('button');
            authorBtn.id = 'authorbox';
            authorBtn.className = 'album-next-one';
            authorBtn.textContent = 'AUTHOR';
            const btnRow = copyBox[0]?.parentElement;
            if (btnRow) {
                btnRow.insertBefore(authorBtn, copyBox[0].nextSibling);
            }

            const downloadBtn = document.getElementById('downloadbox');
            if (downloadBtn) downloadBtn.disabled = true;

            function formatNumber(n, digits = 1) {
                if (typeof n !== 'number' || !isFinite(n)) return '';
                const p = Math.pow(10, digits);
                return String(Math.round(n * p) / p);
            }

            function formatExposureTime(value) {
                if (typeof value !== 'number' || !isFinite(value) || value <= 0) return '';
                if (value >= 1) return `${formatNumber(value, 3)}s`;
                const inv = Math.round(1 / value);
                if (inv >= 1) return `1/${inv}s`;
                return `${formatNumber(value, 6)}s`;
            }

            function parseExifFromJpeg(buffer) {
                const view = new DataView(buffer);
                if (view.byteLength < 4) return {};
                if (view.getUint16(0, false) !== 0xffd8) return {};

                let offset = 2;
                while (offset + 4 <= view.byteLength) {
                    if (view.getUint8(offset) !== 0xff) break;
                    const marker = view.getUint8(offset + 1);
                    if (marker === 0xda) break;
                    const size = view.getUint16(offset + 2, false);
                    if (size < 2) break;
                    if (marker === 0xe1) {
                        const headerOffset = offset + 4;
                        const headerLength = 6;
                        if (headerOffset + headerLength <= view.byteLength) {
                            const exifHeader = String.fromCharCode(
                                view.getUint8(headerOffset + 0),
                                view.getUint8(headerOffset + 1),
                                view.getUint8(headerOffset + 2),
                                view.getUint8(headerOffset + 3)
                            );
                            if (exifHeader === 'Exif') {
                                const tiffOffset = headerOffset + 6;
                                return parseTiff(view, tiffOffset);
                            }
                        }
                    }
                    offset += 2 + size;
                }
                return {};
            }

            function parseTiff(view, tiffOffset) {
                if (tiffOffset + 8 > view.byteLength) return {};
                const byteOrder = view.getUint16(tiffOffset, false);
                const little = byteOrder === 0x4949;
                if (!little && byteOrder !== 0x4d4d) return {};
                if (view.getUint16(tiffOffset + 2, little) !== 0x002a) return {};
                const ifd0Offset = view.getUint32(tiffOffset + 4, little);
                const tags0 = readIfd(view, tiffOffset, tiffOffset + ifd0Offset, little);
                const make = tags0[0x010f];
                const model = tags0[0x0110];
                const exifIfdPointer = tags0[0x8769];
                const exifTags = typeof exifIfdPointer === 'number'
                    ? readIfd(view, tiffOffset, tiffOffset + exifIfdPointer, little)
                    : {};
                return {
                    make,
                    model,
                    dateTimeOriginal: exifTags[0x9003],
                    exposureTime: exifTags[0x829a],
                    fNumber: exifTags[0x829d],
                    iso: exifTags[0x8827],
                    focalLength: exifTags[0x920a],
                    lensModel: exifTags[0xa434],
                };
            }

            function readIfd(view, tiffStart, dirStart, little) {
                if (dirStart + 2 > view.byteLength) return {};
                const entries = view.getUint16(dirStart, little);
                const tags = {};
                const entrySize = 12;
                const max = dirStart + 2 + entries * entrySize;
                if (max > view.byteLength) return {};

                for (let i = 0; i < entries; i++) {
                    const entryOffset = dirStart + 2 + i * entrySize;
                    const tag = view.getUint16(entryOffset, little);
                    const type = view.getUint16(entryOffset + 2, little);
                    const count = view.getUint32(entryOffset + 4, little);
                    const valueOffset = entryOffset + 8;

                    const value = readTagValue(view, tiffStart, valueOffset, type, count, little);
                    if (value !== undefined) {
                        tags[tag] = value;
                    }
                }
                return tags;
            }

            function readTagValue(view, tiffStart, valueOffset, type, count, little) {
                const typeSizes = {
                    1: 1,
                    2: 1,
                    3: 2,
                    4: 4,
                    5: 8,
                    7: 1,
                    9: 4,
                    10: 8,
                };
                const size = typeSizes[type];
                if (!size) return undefined;
                const total = size * count;
                let dataOffset = valueOffset;
                if (total > 4) {
                    const off = view.getUint32(valueOffset, little);
                    dataOffset = tiffStart + off;
                }
                if (dataOffset + total > view.byteLength) return undefined;

                switch (type) {
                    case 2: {
                        let out = '';
                        for (let i = 0; i < count; i++) {
                            const c = view.getUint8(dataOffset + i);
                            if (c === 0) break;
                            out += String.fromCharCode(c);
                        }
                        return out;
                    }
                    case 3: {
                        if (count === 1) return view.getUint16(dataOffset, little);
                        return Array.from({ length: count }, (_, i) => view.getUint16(dataOffset + i * 2, little));
                    }
                    case 4: {
                        if (count === 1) return view.getUint32(dataOffset, little);
                        return Array.from({ length: count }, (_, i) => view.getUint32(dataOffset + i * 4, little));
                    }
                    case 5: {
                        const readOne = (i) => {
                            const num = view.getUint32(dataOffset + i * 8, little);
                            const den = view.getUint32(dataOffset + i * 8 + 4, little);
                            if (!den) return 0;
                            return num / den;
                        };
                        if (count === 1) return readOne(0);
                        return Array.from({ length: count }, (_, i) => readOne(i));
                    }
                    case 9: {
                        if (count === 1) return view.getInt32(dataOffset, little);
                        return Array.from({ length: count }, (_, i) => view.getInt32(dataOffset + i * 4, little));
                    }
                    case 10: {
                        const readOne = (i) => {
                            const num = view.getInt32(dataOffset + i * 8, little);
                            const den = view.getInt32(dataOffset + i * 8 + 4, little);
                            if (!den) return 0;
                            return num / den;
                        };
                        if (count === 1) return readOne(0);
                        return Array.from({ length: count }, (_, i) => readOne(i));
                    }
                    default:
                        return undefined;
                }
            }

            function toDisplayExif(parsed) {
                return {
                    'Image Make': parsed.make || '',
                    'Image Model': parsed.model || '',
                    'EXIF LensModel': parsed.lensModel || '',
                    'EXIF DateTimeOriginal': parsed.dateTimeOriginal || '',
                    'EXIF ISOSpeedRatings': parsed.iso ? `ISO ${parsed.iso}` : '',
                    'EXIF FNumber': parsed.fNumber ? `F${formatNumber(parsed.fNumber, 1)}` : '',
                    'EXIF FocalLength': parsed.focalLength ? `${formatNumber(parsed.focalLength, 1)}mm` : '',
                    'EXIF ExposureTime': parsed.exposureTime ? formatExposureTime(parsed.exposureTime) : '',
                };
            }

            function updateExifUI(exifData) {
                lastExifData = exifData;
                const hasExif = Object.values(exifData).some((v) => String(v).trim() !== '');
                lastHasExif = hasExif;
                $("#wrapper").show();
                if (!hasExif) {
                    wrapper.hide();
                    normalWrapper.show();
                    normalData.text("Shot By " + currentAuthor);
                    return;
                }
                wrapper.show();
                normalWrapper.hide();
                wrapperData({ exif_data: exifData }, currentAuthor);
            }

            authorBtn.addEventListener('click', () => {
                const next = window.prompt('Author', currentAuthor);
                if (next === null) return;
                currentAuthor = String(next).trim() || "<%- config.author %>";
                localStorage.setItem(AUTHOR_KEY, currentAuthor);
                if (!hasLoadedImage) return;
                if (lastHasExif && lastExifData) {
                    updateExifUI(lastExifData);
                    return;
                }
                wrapper.hide();
                normalWrapper.show();
                normalData.text('Shot By ' + currentAuthor);
            });

            copyBox.click(function () {
                fileInput.click();
            });

            fileInput.addEventListener('change', async () => {
                const file = fileInput.files && fileInput.files[0];
                if (!file) return;

                currentFilename = (file.name || 'image').replace(/\.[^/.]+$/, '') || 'image';
                descBox.text(currentFilename);
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                }
                currentObjectUrl = URL.createObjectURL(file);
                imageBox.src = currentObjectUrl;
                if (downloadBtn) downloadBtn.disabled = false;
                hasLoadedImage = true;

                const buffer = await file.arrayBuffer();
                const parsed = parseExifFromJpeg(buffer);
                const exifData = toDisplayExif(parsed);
                updateExifUI(exifData);
            });

            $("#downloadbox").click(function () {
                var node = document.getElementById('all-pic');
                html2canvas(node, {
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                }).then(function (canvas) {
                    simulateDownloadImageClick(canvas.toDataURL('image/png'), currentFilename + '.png');
                });
            });

            $("#wrapper").hide();
            wrapper.hide();
            normalWrapper.show();
            normalData.text("Load an image to see EXIF");
        </script>
</section>
